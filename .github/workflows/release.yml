name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Publish Release
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version info
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release Tag: $TAG"
          echo "üì¶ App Version: $VERSION"

      - name: Update Appcast
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          mkdir -p updates

          # 1. Download EXISTING appcast.xml to preserve history
          echo "‚¨áÔ∏è Downloading existing appcast from previous release..."
          if gh release download -p appcast.xml -D updates 2>/dev/null; then
            echo "‚úÖ Downloaded existing appcast.xml"
          else
            echo "üìù No existing appcast found, creating new one..."
            echo '<?xml version="1.0" encoding="UTF-8"?>' > updates/appcast.xml
            echo '<rss xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" version="2.0">' >> updates/appcast.xml
            echo '    <channel>' >> updates/appcast.xml
            echo '        <title>Notimanager</title>' >> updates/appcast.xml
            echo '    </channel>' >> updates/appcast.xml
            echo '</rss>' >> updates/appcast.xml
          fi

          # 2. Run Python script to APPEND the new version entry
          echo "üìã Appending new version ${VERSION} to appcast..."

          python3 scripts/generate_appcast_from_changelog.py \
            --changelog docs/CHANGELOG.md \
            --appcast updates/appcast.xml \
            --version "$VERSION" \
            --url "https://github.com/abd3lraouf/Notimanager/releases/download/${TAG}/Notimanager-${VERSION}.dmg" \
            --signature "placeholder" \
            --length "placeholder"

          echo ""
          echo "üìã Appcast preview (first 50 lines):"
          head -50 updates/appcast.xml

      - name: Generate changelog
        id: changelog
        run: |
          echo "üìã Generating changelog..."
          VERSION="${{ steps.version.outputs.version }}"

          # Extract current version only from CHANGELOG.md
          if [ -f "docs/CHANGELOG.md" ]; then
            awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{if(!/^## \[$VERSION\]/) flag=0} flag" docs/CHANGELOG.md > release_notes_current.md 2>/dev/null || true

            if [ -s release_notes_current.md ]; then
              echo "‚úÖ Changelog extracted for $VERSION"
              echo "üìã Release Notes:"
              cat release_notes_current.md
            else
              echo "‚ö†Ô∏è  No entry found for $VERSION in CHANGELOG.md, using git log..."
              git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD > release_notes_current.md
            fi
          else
            echo "üìù No CHANGELOG.md found, generating from git log..."
            git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD > release_notes_current.md
          fi

          # Create full release notes for GitHub Release
          cat > release_notes_full.md << EOF
          For installation instructions and documentation, please see [the README](https://github.com/abd3lraouf/Notimanager#readme).

          ---

          EOF

          cat release_notes_current.md >> release_notes_full.md

          # Add full changelog link
          cat >> release_notes_full.md << 'EOF'

          ---
          **Full Changelog**: https://github.com/abd3lraouf/Notimanager/compare/$PREV_TAG...v$VERSION
          EOF

          # Add previous tag for comparison link
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            sed -i '' "s/\$PREV_TAG/$PREV_TAG/g" release_notes_full.md
          else
            sed -i '' 's/\$PREV_TAG/v0.0.0/g' release_notes_full.md
          fi

          sed -i '' "s/\$VERSION/$VERSION/g" release_notes_full.md

          echo "üìã GitHub Release Notes:"
          cat release_notes_full.md

      - name: Create GitHub Release (Draft)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Notimanager ${{ steps.version.outputs.version }}
          body_path: release_notes_full.md
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for uploaded artifacts
        run: |
          echo "üì¶ This release is set as draft."
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: You must build and attach artifacts manually:"
          echo "   1. Build locally: ./scripts/build.sh all"
          echo "   2. You'll get: Notimanager-${VERSION}.dmg"
          echo "   3. Sign the DMG with your Apple Development certificate"
          echo "   4. Go to: https://github.com/abd3lraouf/Notimanager/releases/tag/v${VERSION}"
          echo "   5. Edit the release and attach the DMG file"
          echo "   6. Update the appcast.xml with the real signature:"
          echo "      - Sign the DMG: ./bin/sign_update --ed-key-file your_key.pem Notimanager-${VERSION}.dmg"
          echo "      - Update the signature and size in appcast.xml"
          echo "   7. Mark as published"
          echo ""
          echo "üìã Release URL: https://github.com/abd3lraouf/Notimanager/releases/tag/v${VERSION}"
