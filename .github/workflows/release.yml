name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install create-dmg
        run: |
          echo "üì¶ Installing create-dmg..."
          brew install create-dmg
          echo "‚úÖ create-dmg installed"
          create-dmg --version || true

      - name: Install Sparkle tools
        run: |
          echo "üì¶ Installing Sparkle for appcast generation..."
          # Download Sparkle tools for generate_appcast
          wget https://github.com/sparkle-project/Sparkle/releases/download/2.7.0/Sparkle-2.7.0.tar.xz -O sparkle.tar.xz
          tar xf sparkle.tar.xz
          # Sparkle 2.x extracts into the current directory (bin/ and Sparkle.framework/)
          # We must keep the relative structure for the tool to work
          echo "‚úÖ Sparkle tools installed"

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release Tag: $TAG"
          echo "üì¶ App Version: $VERSION"

      - name: Configure code signing
        run: |
          echo "üîè Using ad-hoc code signing for distribution"
          echo "CODE_SIGN_IDENTITY=-" >> $GITHUB_ENV
          echo "CODE_SIGNING_REQUIRED=NO" >> $GITHUB_ENV
          echo "CODE_SIGNING_ALLOWED=NO" >> $GITHUB_ENV

      - name: Update build version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" \
            Notimanager/Resources/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" \
            Notimanager/Resources/Info.plist
          echo "‚úÖ Build version updated to $VERSION"

      - name: Install icon generation dependencies
        run: |
          echo "üì¶ Installing librsvg for icon generation..."
          brew install librsvg
          echo "‚úÖ Dependencies installed"

      - name: Generate icons
        run: |
          echo "üé® Generating icons from SVG sources..."
          ./scripts/generate-all-icons.sh
          echo "‚úÖ Icons generated"

      - name: Build and archive
        run: |
          echo "üî® Building Notimanager with ad-hoc signing..."

          xcodebuild archive \
            -scheme Notimanager \
            -archivePath build/Notimanager.xcarchive \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO || exit 1

          echo "‚úÖ Archive created"

      - name: Export app bundle
        run: |
          echo "üì¶ Exporting app bundle..."
          mkdir -p build/release
          cp -R build/Notimanager.xcarchive/Products/Applications/Notimanager.app \
            build/release/Notimanager.app

          # Copy .icns file to app bundle for System Settings
          if [ -f "Notimanager/Resources/AppIcon.icns" ]; then
            echo "üì¶ Copying app icon to bundle..."
            cp Notimanager/Resources/AppIcon.icns build/release/Notimanager.app/Contents/Resources/
            echo "‚úÖ App icon copied"
          fi

          # Verify the app was copied
          if [ -d "build/release/Notimanager.app" ]; then
            echo "‚úÖ App bundle exported"
            ls -la build/release/Notimanager.app
          else
            echo "‚ùå Failed to export app bundle"
            exit 1
          fi

      - name: Verify code signature
        run: |
          echo "üîç Verifying code signature..."
          codesign -dv build/release/Notimanager.app 2>&1 | head -5
          echo ""
          echo "üìã Code signature details:"
          codesign -d -r - build/release/Notimanager.app 2>&1 | head -10

      - name: Create ZIP archive
        run: |
          echo "üóúÔ∏è  Creating release archive..."
          cd build/release
          zip -r Notimanager-macOS.zip Notimanager.app
          cd ../..
          mv build/release/Notimanager-macOS.zip build/
          echo "‚úÖ Archive created: build/Notimanager-macOS.zip"

      - name: Create DMG
        run: |
          echo "üíø Creating DMG installer..."
          ./scripts/create-dmg.sh --dev --no-sign
          if [ -f "build/Notimanager-macOS.dmg" ]; then
            echo "‚úÖ DMG created"
            ls -lh build/Notimanager-macOS.dmg
          else
            echo "‚ö†Ô∏è  DMG not created"
            exit 1
          fi

      - name: Rename DMG with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "üìù Renaming DMG to include version..."
          mv "build/Notimanager-macOS.dmg" "build/Notimanager-${VERSION}.dmg"
          echo "‚úÖ DMG renamed to Notimanager-${VERSION}.dmg"
          ls -lh "build/Notimanager-${VERSION}.dmg"

      - name: Generate appcast
        run: |
          echo "üì° Generating Sparkle appcast..."
          VERSION="${{ steps.version.outputs.version }}"

          # Create updates folder
          mkdir -p updates

          # Copy DMG to updates folder
          cp "build/Notimanager-${VERSION}.dmg" "updates/Notimanager-${VERSION}.dmg"

          # Download previous release appcast.xml to preserve all versions
          echo "üì• Downloading previous appcast to preserve version history..."
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "Found previous tag: $PREV_TAG"
            gh release download "$PREV_TAG" -p "appcast.xml" -O updates/prev_appcast.xml || echo "‚ö†Ô∏è Could not download previous appcast"
            gh release download "$PREV_TAG" -p "*.dmg" -D updates || echo "‚ö†Ô∏è Could not download previous release artifacts for delta generation"
          else
            echo "‚ö†Ô∏è No previous tag found"
          fi

          # Generate new appcast with current version
          if [ -n "${{ secrets.SPARKLE_PRIVATE_KEY }}" ]; then
            echo "üìù Signing appcast with private key (file-based)..."
            echo "${{ secrets.SPARKLE_PRIVATE_KEY }}" | base64 -d > sparkle_private_key.pem
            ./bin/generate_appcast updates --ed-key-file sparkle_private_key.pem
          else
            echo "‚ö†Ô∏è  Generating appcast without signature (development only)"
            ./bin/generate_appcast updates
          fi

          # Merge previous appcast entries to preserve all versions
          if [ -f "updates/prev_appcast.xml" ]; then
            echo "üîó Merging previous appcast entries..."
            python3 << PYTHON
            import re
            import xml.etree.ElementTree as ET

            # Parse current appcast (has only new version)
            with open('updates/appcast.xml', 'r') as f:
                current_content = f.read()

            # Parse previous appcast (has all old versions)
            with open('updates/prev_appcast.xml', 'r') as f:
                prev_content = f.read()

            # Extract the channel content from current
            current_match = re.search(r'<channel>(.*?)</channel>', current_content, re.DOTALL)
            if not current_match:
                print("‚ö†Ô∏è Could not parse current appcast")
                exit(1)

            current_channel = current_match.group(1)

            # Extract items from previous appcast
            prev_items = re.findall(r'<item>.*?</item>', prev_content, re.DOTALL)

            # Extract current version to avoid duplicates
            current_version_match = re.search(r'<sparkle:version>([^<]+)</sparkle:version>', current_channel)
            current_version = current_version_match.group(1) if current_version_match else ""

            # Filter out items with same version from previous appcast
            filtered_prev_items = []
            for item in prev_items:
                item_version_match = re.search(r'<sparkle:version>([^<]+)</sparkle:version>', item)
                if item_version_match:
                    item_version = item_version_match.group(1)
                    # Only include items with version < current version
                    # Simple string comparison for now, could be improved with proper version parsing
                    if item_version != current_version:
                        filtered_prev_items.append(item)

            # Build new channel content with all items
            # Extract current item from current appcast
            current_item_match = re.search(r'(<item>.*?</item>)', current_channel, re.DOTALL)
            current_item = current_item_match.group(1) if current_item_match else ""

            # Combine: current item first, then all previous items (newest first)
            all_items = [current_item] + filtered_prev_items

            # Reconstruct the RSS feed
            new_content = '''<?xml version="1.0" standalone="yes"?>
<rss xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" version="2.0">
    <channel>
        <title>Notimanager</title>
''' + '\n'.join(all_items) + '''
    </channel>
</rss>'''

            with open('updates/appcast.xml', 'w') as f:
                f.write(new_content)

            print(f"‚úÖ Merged {len(filtered_prev_items)} previous version(s) into appcast")
            PYTHON
          fi

          # Patch appcast.xml to use absolute URLs for GitHub Releases
          if [ -f "updates/appcast.xml" ]; then
            echo "üîß Patching appcast with absolute URLs..."
            # Replace local filename with full GitHub Release URL
            sed -i '' "s|url=\"Notimanager-${VERSION}.dmg\"|url=\"https://github.com/abd3lraouf/Notimanager/releases/download/v${VERSION}/Notimanager-${VERSION}.dmg\"|g" updates/appcast.xml

            # Patch delta update URLs
            sed -i '' "s|url=\"\([^\" ]*\.delta\)\"|url=\"https://github.com/abd3lraouf/Notimanager/releases/download/v${VERSION}/\1\"|g" updates/appcast.xml

            echo "‚úÖ Appcast patched with all versions"
            cat updates/appcast.xml
          fi

      - name: Upload appcast as artifact
        uses: actions/upload-artifact@v4
        with:
          name: appcast-xml
          path: updates/appcast.xml
          retention-days: 90

      - name: Generate changelog
        id: changelog
        run: |
          echo "üìã Generating changelog..."
          VERSION="${{ steps.version.outputs.version }}"

          # Extract current version only from CHANGELOG.md for both Sparkle and GitHub Release
          # Sparkle will aggregate descriptions from multiple versions automatically
          if [ -f "docs/CHANGELOG.md" ]; then
            awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{if(!/^## \[$VERSION\]/) flag=0} flag" docs/CHANGELOG.md > release_notes_current.md 2>/dev/null || true

            if [ -s release_notes_current.md ]; then
              echo "‚úÖ Changelog extracted for $VERSION"
              echo "üìã Release Notes:"
              cat release_notes_current.md
            else
              echo "‚ö†Ô∏è  No entry found for $VERSION in CHANGELOG.md, using git log..."
              git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD > release_notes_current.md
            fi
          else
            echo "üìù No CHANGELOG.md found, generating from git log..."
            git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD > release_notes_current.md
          fi

          # Create full release notes for GitHub Release
          cat > release_notes_full.md << EOF
          For installation instructions and documentation, please see [the README](https://github.com/abd3lraouf/Notimanager#readme).

          ---

          EOF

          cat release_notes_current.md >> release_notes_full.md

          # Add full changelog link
          cat >> release_notes_full.md << 'EOF'

          ---
          **Full Changelog**: https://github.com/abd3lraouf/Notimanager/compare/$PREV_TAG...v$VERSION
          EOF

          # Add previous tag for comparison link
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            sed -i '' "s/\$PREV_TAG/$PREV_TAG/g" release_notes_full.md
          else
            sed -i '' 's/\$PREV_TAG/v0.0.0/g' release_notes_full.md
          fi

          sed -i '' "s/\$VERSION/$VERSION/g" release_notes_full.md

          echo "üìã GitHub Release Notes:"
          cat release_notes_full.md

      - name: Generate HTML release notes for Sparkle
        run: |
          echo "üåê Generating HTML release notes for Sparkle..."

          # Create styled HTML from current version changelog only
          # Sparkle will automatically aggregate descriptions from multiple versions
          cat > release_notes.html << 'HTMLHEADER'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
                padding: 16px;
                margin: 0;
                line-height: 1.5;
                color: #333;
              }
              h3 {
                font-size: 16px;
                font-weight: 600;
                margin-top: 20px;
                margin-bottom: 8px;
                color: #1d1d1f;
              }
              h4 {
                font-size: 13px;
                font-weight: 600;
                margin-top: 12px;
                margin-bottom: 6px;
                color: #6e6e73;
              }
              ul {
                margin: 0 0 12px 0;
                padding-left: 18px;
              }
              li {
                margin-bottom: 4px;
                font-size: 13px;
                color: #1d1d1f;
              }
              code {
                font-family: "SF Mono", Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
                font-size: 12px;
                background: #f5f5f7;
                padding: 2px 5px;
                border-radius: 3px;
              }
              strong {
                font-weight: 600;
              }
            </style>
          </head>
          <body>
          HTMLHEADER

          # Convert markdown to HTML using our Python script
          python3 scripts/markdown_to_html.py release_notes_current.md >> release_notes.html

          cat >> release_notes.html << 'HTMLFOOTER'
          </body>
          </html>
          HTMLFOOTER

          echo "‚úÖ HTML release notes generated"

      - name: Inject release notes into appcast
        run: |
          echo "üíâ Injecting HTML release notes into appcast.xml..."

          VERSION="${{ steps.version.outputs.version }}"

          if [ ! -f "updates/appcast.xml" ]; then
            echo "‚ùå appcast.xml not found!"
            exit 1
          fi

          # Read the HTML content
          HTML_CONTENT=$(cat release_notes.html)

          # Escape special characters for XML CDATA
          # We only need to escape ]]> as it breaks CDATA
          HTML_CONTENT=$(echo "$HTML_CONTENT" | sed 's/]]]/]]]]><![CDATA[>/g')

          # Create the description element with CDATA
          DESCRIPTION="<description><![CDATA[${HTML_CONTENT}]]></description>"

          # Insert the description into the appcast.xml
          # We want to insert it after the <enclosure> element for the current version
          # Using a more robust approach: find the item with our version and insert description
          python3 << PYTHON
          import re

          with open('updates/appcast.xml', 'r') as f:
              content = f.read()

          # Read the HTML content
          with open('release_notes.html', 'r') as f:
              html_content = f.read()

          # Escape CDATA end marker
          html_content = html_content.replace(']]>', ']]]]><![CDATA[>')

          # Create the description element
          description = f'<description><![CDATA[{html_content}]]></description>'

          # Find the item for this version and insert description after <enclosure>
          # Pattern: find <enclosure.../> and insert description after it
          pattern = r'(<enclosure[^>]*>)'

          def replacer(match):
              return match.group(1) + '\\n' + description

          # Only replace the first occurrence (current version)
          new_content = re.sub(pattern, replacer, content, count=1)

          with open('updates/appcast.xml', 'w') as f:
              f.write(new_content)

          print("‚úÖ Description injected into appcast.xml")
          PYTHON

          echo "üìã Updated appcast.xml:"
          cat updates/appcast.xml

      - name: Upload updated appcast as artifact
        uses: actions/upload-artifact@v4
        with:
          name: appcast-xml
          path: updates/appcast.xml
          retention-days: 90
          overwrite: true

      - name: Prepare release artifacts
        id: artifacts
        run: |
          echo "üì¶ Preparing release artifacts..."
          VERSION="${{ steps.version.outputs.version }}"
          {
            echo "RELEASE_FILES<<EOF"
            echo "build/Notimanager-macOS.zip"
            echo "build/Notimanager-${VERSION}.dmg"
            echo "updates/appcast.xml"
            # Include deltas if they exist
            if ls updates/*.delta 1> /dev/null 2>&1; then
              echo "updates/*.delta"
            fi
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Notimanager ${{ steps.version.outputs.version }}
          body_path: release_notes_full.md
          files: ${{ env.RELEASE_FILES }}
          fail_on_unmatched_files: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Notimanager-${{ steps.version.outputs.version }}
          path: |
            build/Notimanager-macOS.zip
            build/Notimanager-${{ steps.version.outputs.version }}.dmg
            build/release/Notimanager.app
          retention-days: 30
          if-no-files-found: ignore
