name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.1.19)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install tools
        run: |
          echo "üì¶ Installing create-dmg and dependencies..."
          npm install --global create-dmg
          brew install librsvg
          echo "‚úÖ Dependencies installed"

      - name: Install Sparkle tools
        run: |
          echo "üì¶ Installing Sparkle for appcast generation..."
          wget https://github.com/sparkle-project/Sparkle/releases/download/2.7.0/Sparkle-2.7.0.tar.xz -O sparkle.tar.xz
          tar xf sparkle.tar.xz
          echo "‚úÖ Sparkle tools installed"

      - name: Extract version info
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release Tag: $TAG"
          echo "üì¶ App Version: $VERSION"

      - name: Setup code signing
        run: |
          echo "üîè Setting up code signing..."

          # CI uses ad-hoc signing since certificates can't be easily exported
          # Users will need to right-click and select "Open" on first launch
          echo "CODE_SIGNING_REQUIRED=NO" >> $GITHUB_ENV
          echo "CODE_SIGNING_ALLOWED=NO" >> $GITHUB_ENV
          echo "USE_CODE_SIGNING=false" >> $GITHUB_ENV

          echo "‚úÖ Code signing configured (ad-hoc for CI)"
          echo "‚ö†Ô∏è  Users will need to right-click and 'Open' on first launch"

      - name: Update build version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" \
            Notimanager/Resources/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" \
            Notimanager/Resources/Info.plist
          echo "‚úÖ Build version updated to $VERSION"

      - name: Generate icons
        run: |
          echo "üé® Generating icons from SVG sources..."
          ./scripts/generate-all-icons.sh
          echo "‚úÖ Icons generated"

      - name: Build and archive
        run: |
          echo "üî® Building Notimanager with ad-hoc code signing..."

          # Use ad-hoc signing for CI (no certificate required)
          if [ "$USE_CODE_SIGNING" = "true" ]; then
            echo "üîè Using certificate-based signing"
            xcodebuild archive \
              -scheme Notimanager \
              -archivePath build/Notimanager.xcarchive \
              -destination 'platform=macOS' \
              CODE_SIGN_STYLE=Manual \
              CODE_SIGN_IDENTITY="Apple Development" \
              DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
              CODE_SIGNING_REQUIRED=YES \
              CODE_SIGNING_ALLOWED=YES || exit 1
          else
            echo "‚ö†Ô∏è  Using ad-hoc signing (no certificate)"
            xcodebuild archive \
              -scheme Notimanager \
              -archivePath build/Notimanager.xcarchive \
              -destination 'platform=macOS' \
              CODE_SIGN_IDENTITY="-" \
              CODE_SIGN_STYLE=Manual \
              DEVELOPMENT_TEAM="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO || exit 1
          fi

          echo "‚úÖ Archive created"

      - name: Export app bundle
        run: |
          echo "üì¶ Exporting app bundle..."
          mkdir -p build/release
          cp -R build/Notimanager.xcarchive/Products/Applications/Notimanager.app \
            build/release/Notimanager.app

          # Copy .icns file to app bundle for System Settings
          if [ -f "Notimanager/Resources/AppIcon.icns" ]; then
            echo "üì¶ Copying app icon to bundle..."
            cp Notimanager/Resources/AppIcon.icns build/release/Notimanager.app/Contents/Resources/
            echo "‚úÖ App icon copied"
          fi

          # Verify the app was copied
          if [ -d "build/release/Notimanager.app" ]; then
            echo "‚úÖ App bundle exported"
            ls -la build/release/Notimanager.app
          else
            echo "‚ùå Failed to export app bundle"
            exit 1
          fi

      - name: Verify code signature
        run: |
          echo "üîç Verifying code signature..."
          codesign -dv build/release/Notimanager.app 2>&1 | head -5
          echo ""
          echo "üìã Code signature details:"
          codesign -d -r - build/release/Notimanager.app 2>&1 | head -10

      - name: Create DMG
        run: |
          echo "üíø Creating DMG installer..."

          # Find available certificate for DMG signing
          CERT_ID=$(security find-identity -v -p codesigning 2>/dev/null | grep "Apple Development" | head -1 | awk '{print $2}')

          if [ -n "$CERT_ID" ]; then
            echo "üîè Signing DMG with Apple Development certificate: $CERT_ID"
            ./scripts/create-dmg.sh --sign "$CERT_ID"
          else
            echo "‚ö†Ô∏è  No certificate found, creating unsigned DMG"
            ./scripts/create-dmg.sh --dev --no-sign
          fi

          if [ -f "build/Notimanager-macOS.dmg" ]; then
            echo "‚úÖ DMG created"
            ls -lh build/Notimanager-macOS.dmg
          else
            echo "‚ö†Ô∏è  DMG not created"
            exit 1
          fi

      - name: Rename DMG with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "üìù Renaming DMG to include version..."
          mv "build/Notimanager-macOS.dmg" "build/Notimanager-${VERSION}.dmg"
          echo "‚úÖ DMG renamed to Notimanager-${VERSION}.dmg"
          ls -lh "build/Notimanager-${VERSION}.dmg"

      # ------------------------------------------------------------------
      # STEP: Sign Update & Prepare Appcast
      # ------------------------------------------------------------------

      - name: Sign Update
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_PATH="build/Notimanager-${VERSION}.dmg"

          echo "üîè Signing update package..."

          # 1. Write the private key to a temp file
          echo "$SPARKLE_PRIVATE_KEY" > sparkle_key.pem

          # 2. Calculate the EdDSA Signature using Sparkle's sign_update tool
          SIGNATURE=$(./bin/sign_update --ed-key-file sparkle_key.pem "$DMG_PATH")

          # 3. Clean up the key file
          rm sparkle_key.pem

          # 4. Get File Size
          FILE_SIZE=$(stat -f%z "$DMG_PATH")

          echo "‚úÖ Signature generated"
          echo "   Size: $FILE_SIZE bytes"
          echo "   Signature: ${SIGNATURE:0:30}..."

          # 5. Export to GitHub Output for the next step
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
          echo "size=$FILE_SIZE" >> $GITHUB_OUTPUT

      - name: Update Appcast
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          mkdir -p updates

          # 1. Download EXISTING appcast.xml to preserve history
          echo "‚¨áÔ∏è Downloading existing appcast from previous release..."
          if gh release download -p appcast.xml -D updates 2>/dev/null; then
            echo "‚úÖ Downloaded existing appcast.xml"
          else
            echo "üìù No existing appcast found, creating new one..."
            mkdir -p updates
            echo '<?xml version="1.0" encoding="UTF-8"?>' > updates/appcast.xml
            echo '<rss xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" version="2.0">' >> updates/appcast.xml
            echo '    <channel>' >> updates/appcast.xml
            echo '        <title>Notimanager</title>' >> updates/appcast.xml
            echo '    </channel>' >> updates/appcast.xml
            echo '</rss>' >> updates/appcast.xml
          fi

          # 2. Run Python script to APPEND the new version entry
          echo "üìã Appending new version ${VERSION} to appcast..."

          python3 scripts/generate_appcast_from_changelog.py \
            --changelog docs/CHANGELOG.md \
            --appcast updates/appcast.xml \
            --version "$VERSION" \
            --url "https://github.com/abd3lraouf/Notimanager/releases/download/${TAG}/Notimanager-${VERSION}.dmg" \
            --signature "${{ steps.sign.outputs.signature }}" \
            --length "${{ steps.sign.outputs.size }}"

          echo ""
          echo "üìã Appcast preview (first 50 lines):"
          head -50 updates/appcast.xml

      # ------------------------------------------------------------------

      - name: Generate changelog
        id: changelog
        run: |
          echo "üìã Generating changelog..."
          VERSION="${{ steps.version.outputs.version }}"

          # Extract current version only from CHANGELOG.md
          if [ -f "docs/CHANGELOG.md" ]; then
            awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{if(!/^## \[$VERSION\]/) flag=0} flag" docs/CHANGELOG.md > release_notes_current.md 2>/dev/null || true

            if [ -s release_notes_current.md ]; then
              echo "‚úÖ Changelog extracted for $VERSION"
              echo "üìã Release Notes:"
              cat release_notes_current.md
            else
              echo "‚ö†Ô∏è  No entry found for $VERSION in CHANGELOG.md, using git log..."
              git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD > release_notes_current.md
            fi
          else
            echo "üìù No CHANGELOG.md found, generating from git log..."
            git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD > release_notes_current.md
          fi

          # Create full release notes for GitHub Release
          cat > release_notes_full.md << EOF
          For installation instructions and documentation, please see [the README](https://github.com/abd3lraouf/Notimanager#readme).

          ---

          EOF

          cat release_notes_current.md >> release_notes_full.md

          # Add full changelog link
          cat >> release_notes_full.md << 'EOF'

          ---
          **Full Changelog**: https://github.com/abd3lraouf/Notimanager/compare/$PREV_TAG...v$VERSION
          EOF

          # Add previous tag for comparison link
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            sed -i '' "s/\$PREV_TAG/$PREV_TAG/g" release_notes_full.md
          else
            sed -i '' 's/\$PREV_TAG/v0.0.0/g' release_notes_full.md
          fi

          sed -i '' "s/\$VERSION/$VERSION/g" release_notes_full.md

          echo "üìã GitHub Release Notes:"
          cat release_notes_full.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Notimanager ${{ steps.version.outputs.version }}
          body_path: release_notes_full.md
          files: |
            build/Notimanager-${{ steps.version.outputs.version }}.dmg
            updates/appcast.xml
          fail_on_unmatched_files: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Notimanager-${{ steps.version.outputs.version }}
          path: |
            build/Notimanager-${{ steps.version.outputs.version }}.dmg
            build/release/Notimanager.app
            updates/appcast.xml
          retention-days: 30
          if-no-files-found: ignore
